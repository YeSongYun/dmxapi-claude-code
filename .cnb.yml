# ============================================
# CNB äº‘åŸç”Ÿæ„å»ºé…ç½®
# ============================================

# ä¸»åˆ†æ”¯æ¨é€ - åŒæ­¥åˆ° GitHub
main:
  push:
    - imports: https://cnb.cool/dmxapi/claude-code-my/-/blob/main/env.yml
      stages:
        - name: sync to github with rebase
          image: tencentcom/git-sync
          settings:
            target_url: https://github.com/YeSongYun/dmxapi-claude-code.git
            auth_type: https
            username: ${GIT_USERNAME}
            password: ${GIT_ACCESS_TOKEN}
            sync_mode: rebase

# Tag æ¨é€ - è‡ªåŠ¨å‘å¸ƒ Release
$:
  tag_push:
    - imports: https://cnb.cool/dmxapi/claude-code-my/-/blob/main/env.yml
      stages:
        # 0. å…ˆåŒæ­¥ Tag åˆ° GitHub
        - name: sync tag to github
          image: alpine/git
          script:
            - git remote add github https://${GIT_USERNAME}:${GIT_ACCESS_TOKEN}@github.com/YeSongYun/dmxapi-claude-code.git || true
            - git push github ${CNB_BRANCH} --force
        # 1. ç”Ÿæˆæ›´æ–°æ—¥å¿—ï¼ˆä½¿ç”¨ git-cliff æ”¯æŒ commit è‡ªåŠ¨åˆ†ç±»ï¼‰
        - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
          image: cnbcool/default-build-env
          script:
            - curl -sSL https://github.com/orhun/git-cliff/releases/download/v2.7.0/git-cliff-2.7.0-x86_64-unknown-linux-gnu.tar.gz | tar xz
            - git fetch --tags origin
            - ./git-cliff-2.7.0/git-cliff --config cliff.toml --latest --strip header
          exports:
            stdout: RELEASE_NOTES

        # 2. ç¼–è¯‘å„å¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
        - name: ç¼–è¯‘ Windows AMD64
          image: golang:1.21
          script:
            - CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o dmxapi-claude-code-${CNB_BRANCH}-windows-amd64.exe

        - name: ç¼–è¯‘ Linux AMD64
          image: golang:1.21
          script:
            - CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o dmxapi-claude-code-${CNB_BRANCH}-linux-amd64

        - name: ç¼–è¯‘ Linux ARM64
          image: golang:1.21
          script:
            - CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o dmxapi-claude-code-${CNB_BRANCH}-linux-arm64

        - name: ç¼–è¯‘ macOS AMD64
          image: golang:1.21
          script:
            - CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o dmxapi-claude-code-${CNB_BRANCH}-darwin-amd64

        - name: ç¼–è¯‘ macOS ARM64
          image: golang:1.21
          script:
            - CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o dmxapi-claude-code-${CNB_BRANCH}-darwin-arm64

        # 3. å…ˆåˆ›å»º Releaseï¼ˆå¿…é¡»åœ¨ä¸Šä¼ é™„ä»¶ä¹‹å‰ï¼‰
        - name: åˆ›å»º Release
          type: git:release
          options:
            title: DMXAPI Claude Code ${CNB_BRANCH}
            description: |
              ## DMXAPI Claude Code é…ç½®å·¥å…· ${CNB_BRANCH}

              ä¸€é”®é…ç½® Anthropic Claude Code CLI ç¯å¢ƒå˜é‡çš„è·¨å¹³å°å·¥å…·ã€‚

              ---

              ${RELEASE_NOTES}

              ---

              ### ğŸ“¥ ä¸‹è½½

              | å¹³å° | æ¶æ„ | æ–‡ä»¶ |
              |------|------|------|
              | Windows | x64 | `dmxapi-claude-code-${CNB_BRANCH}-windows-amd64.exe` |
              | Linux | x64 | `dmxapi-claude-code-${CNB_BRANCH}-linux-amd64` |
              | Linux | ARM64 | `dmxapi-claude-code-${CNB_BRANCH}-linux-arm64` |
              | macOS | Intel | `dmxapi-claude-code-${CNB_BRANCH}-darwin-amd64` |
              | macOS | Apple Silicon | `dmxapi-claude-code-${CNB_BRANCH}-darwin-arm64` |

              ---

              ### ğŸ› ï¸ å®‰è£…è¯´æ˜

              #### Windows
              ```powershell
              # ä¸‹è½½åç›´æ¥è¿è¡Œ
              .\dmxapi-claude-code-${CNB_BRANCH}-windows-amd64.exe
              ```

              #### Linux
              ```bash
              # ä¸‹è½½å¹¶æ·»åŠ æ‰§è¡Œæƒé™
              chmod +x dmxapi-claude-code-${CNB_BRANCH}-linux-amd64
              ./dmxapi-claude-code-${CNB_BRANCH}-linux-amd64
              ```

              #### macOS
              ```bash
              # ä¸‹è½½å¹¶æ·»åŠ æ‰§è¡Œæƒé™
              chmod +x dmxapi-claude-code-${CNB_BRANCH}-darwin-arm64
              # é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨"ç³»ç»Ÿè®¾ç½® > éšç§ä¸å®‰å…¨æ€§"ä¸­å…è®¸
              ./dmxapi-claude-code-${CNB_BRANCH}-darwin-arm64
              ```

              ---

              ### ğŸ“‹ é…ç½®çš„ç¯å¢ƒå˜é‡

              | ç¯å¢ƒå˜é‡ | è¯´æ˜ |
              |----------|------|
              | `ANTHROPIC_BASE_URL` | API æœåŠ¡å™¨åœ°å€ |
              | `ANTHROPIC_AUTH_TOKEN` | API è®¤è¯ä»¤ç‰Œ |
              | `ANTHROPIC_MODEL` | é»˜è®¤æ¨¡å‹ |
              | `ANTHROPIC_SMALL_FAST_MODEL` | å°å‹å¿«é€Ÿæ¨¡å‹ |

              ---

              ### ğŸ”— ç›¸å…³é“¾æ¥

              - [è·å– API Token](https://www.dmxapi.cn/token)
              - [ä½¿ç”¨æ–‡æ¡£](https://github.com/YeSongYun/dmxapi-claude-code#readme)

        # 4. å†ä¸Šä¼ é™„ä»¶åˆ°å·²åˆ›å»ºçš„ Release
        - name: ä¸Šä¼  Release é™„ä»¶
          image: cnbcool/attachments
          settings:
            attachments:
              - "./dmxapi-claude-code-${CNB_BRANCH}-*"
            ttl: 0

        # 5. æ¸…ç†æ—§ç‰ˆæœ¬ï¼Œåªä¿ç•™æœ€è¿‘3ä¸ª
        - name: æ¸…ç†æ—§ç‰ˆæœ¬
          image: docker.cnb.cool/cnb/plugins/cnbcool/release-clean:latest
          settings:
            filter: "RECENT_N=3"
            debug: false